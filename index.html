<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¸¯å¼æ™ºèƒ½é¤å–®</title>
    <style>
        :root {
            --primary: #00897b; /* æ¸¯å¼ç¢§ç¶  */
            --primary-light: #e0f2f1;
            --primary-dark: #005b4f;
            --accent: #ff6f00; /* ç‡’è‡˜æ©™ */
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --danger: #d32f2f;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 16px;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding-bottom: calc(80px + var(--safe-area-bottom)); 
            overscroll-behavior-y: none;
        }

        /* Header */
        header { 
            background: var(--card-bg); 
            padding: 15px 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        h1 { margin: 0; font-size: 1.3rem; color: var(--primary); font-weight: 800; letter-spacing: -0.5px; }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            background: #eee;
            color: #666;
            font-weight: 600;
        }
        .status-badge.active { background: var(--primary-light); color: var(--primary-dark); }

        /* Navigation */
        nav { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0 calc(10px + var(--safe-area-bottom)) 0; 
            border-top: 1px solid #eee; 
            z-index: 1000; 
        }
        nav button { 
            background: none; 
            border: none; 
            font-size: 0.7rem; 
            color: #999; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px; 
            cursor: pointer; 
            width: 33%;
            transition: color 0.2s;
        }
        nav button.active { color: var(--primary); font-weight: 600; }
        nav button svg { width: 24px; height: 24px; fill: currentColor; }

        /* Views */
        .view { display: none; padding: 20px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card { 
            background: var(--card-bg); 
            border-radius: var(--radius); 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: var(--shadow); 
            position: relative; 
            overflow: hidden;
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        .day-tag { 
            background: var(--primary); 
            color: white; 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 0.9rem; 
            font-weight: bold; 
            box-shadow: 0 2px 4px rgba(0,137,123,0.3);
        }

        /* Meal Sections */
        .meal-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            position: relative;
        }
        .meal-time {
            width: 50px;
            font-size: 0.8rem;
            color: var(--text-light);
            font-weight: 600;
            padding-top: 4px;
        }
        .meal-content {
            flex: 1;
            background: #f9f9f9;
            border-radius: 12px;
            padding: 12px;
        }
        .meal-content.dinner {
            background: #fff8e1; /* æš–è‰²èƒŒæ™¯çµ¦æ™šé¤ */
            border: 1px solid #ffe0b2;
        }
        
        .dish-name { font-size: 1.05rem; font-weight: 700; margin-bottom: 4px; color: var(--text); }
        .dish-desc { font-size: 0.85rem; color: var(--text-light); line-height: 1.4; }
        
        .tags { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
        .tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: #eee; color: #666; }
        .tag.light { background: #e8f5e9; color: #2e7d32; }
        .tag.prep { background: #e3f2fd; color: #1565c0; }

        /* Actions */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 8px;
        }
        .regen-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 4px 10px;
            font-size: 0.75rem;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* New AI Feature Buttons */
        .sparkle-btn {
            background: linear-gradient(135deg, #7b1fa2, #4a148c);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(123, 31, 162, 0.3);
            transition: transform 0.2s;
        }
        .sparkle-btn:hover { transform: translateY(-1px); }
        .sparkle-btn.secondary {
             background: white;
             border: 1px solid #7b1fa2;
             color: #7b1fa2;
             box-shadow: none;
        }
        
        .feedback-btns { display: flex; gap: 8px; margin-left: auto;}
        .feedback-btn {
            background: white;
            border: 1px solid #ddd;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }
        .feedback-btn.active.like { background: var(--primary-light); border-color: var(--primary); color: var(--primary); transform: scale(1.1); }
        .feedback-btn.active.dislike { background: #ffebee; border-color: var(--danger); color: var(--danger); transform: scale(1.1); }

        /* Forms & Inputs */
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--primary-dark); }
        input[type="text"], input[type="password"], input[type="number"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px; /* é˜²æ­¢ iOS zoom */
            transition: border 0.3s;
            background: #fff;
        }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px var(--primary-light); }
        textarea { height: 100px; resize: none; font-family: inherit; }

        /* Checkbox styling */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: normal;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #eee;
            cursor: pointer;
        }
        .checkbox-label input { width: 20px; height: 20px; margin: 0; }

        /* Main Button */
        .btn-main {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,137,123,0.3);
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }
        .btn-ghost {
            background: transparent;
            color: var(--text-light);
            border: 1px solid #ddd;
            margin-top: 10px;
        }
        .btn-outlined {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            margin-top: 10px;
            box-shadow: none;
        }
        
        /* Data Transfer Buttons */
        .data-transfer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .btn-small {
            padding: 10px;
            font-size: 0.9rem;
            border-radius: 10px;
            cursor: pointer;
            border: 1px solid #ddd;
            background: #fff;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        /* Loading */
        .loader-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Shopping List & Filters */
        .shop-filter-container {
            margin-bottom: 20px;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
        }
        .filter-mode-btn {
            border: 1px solid var(--primary);
            background: none;
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .filter-mode-btn.active {
            background: var(--primary);
            color: white;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }
        .day-toggle {
            background: #f5f5f5;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 0.85rem;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
        }
        .day-toggle.active {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary-dark);
        }
        .day-toggle span.menu-name {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .shop-cat { margin-top: 20px; }
        .shop-cat-title { 
            font-weight: 700; 
            color: var(--primary-dark); 
            border-bottom: 2px solid var(--primary-light); 
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .shop-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.95rem;
        }
        .shop-item input { width: 20px; height: 20px; margin-right: 12px; accent-color: var(--primary); }
        .shop-item.checked span { text-decoration: line-through; color: #aaa; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .modal-body h3 { color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 8px; margin-top: 20px; }
        .modal-body ul, .modal-body ol { padding-left: 20px; }
        .modal-body li { margin-bottom: 6px; line-height: 1.5; }

        .analysis-btn-container { margin-bottom: 20px; text-align: center; }

        /* Welcome Popup Specifics */
        .welcome-icon { font-size: 48px; margin-bottom: 15px; display: block; text-align: center; }
        .welcome-actions { display: flex; gap: 10px; margin-top: 20px; }
        .welcome-actions button { flex: 1; }

    </style>
</head>
<body>

<header>
    <h1>ğŸ² æ¸¯å¼æ™ºèƒ½é¤å–®</h1>
    <div id="statusBadge" class="status-badge">API æœªè¨­å®š</div>
</header>

<!-- 1. é¤å–®é é¢ -->
<div id="view-plan" class="view active">
    
    <!-- Loading State -->
    <div id="loading" class="loader-container">
        <div class="spinner"></div>
        <h3 style="color: var(--primary);">AI å¤§å»šæ­£åœ¨æ€è€ƒä¸­...</h3>
        <p style="color: #666; font-size: 0.9rem;">æ­£åœ¨æ ¹æ“šä½ çš„å–œå¥½ã€ç‡Ÿé¤Šå‡è¡¡å’Œè¡—å¸‚é£Ÿæé€²è¡Œè¦åŠƒã€‚</p>
    </div>

    <!-- Plan Content -->
    <div id="plan-container">
        <div class="analysis-btn-container">
             <button onclick="getNutritionReport()" class="sparkle-btn" style="font-size: 0.9rem; padding: 8px 16px; margin: 0 auto;">
                âœ¨ åˆ†ææœ¬é€±ç‡Ÿé¤Šå‡è¡¡åº¦
            </button>
        </div>
        <div id="plan-list"></div>
    </div>
</div>

<!-- 2. è³¼ç‰©æ¸…å–®é é¢ -->
<div id="view-shop" class="view">
    <div class="card">
        <h2 style="margin-top:0;">ğŸ›’ è³¼è²·é£Ÿæ</h2>
        
        <!-- Filter Controls -->
        <div id="shop-filters" class="shop-filter-container" style="display:none;">
            <div class="filter-controls">
                <button class="filter-mode-btn active" id="btn-filter-all" onclick="setFilterMode('all')">ğŸ“… æ•´é€±å…¨é¸</button>
                <button class="filter-mode-btn" id="btn-filter-select" onclick="setFilterMode('select')">ğŸ“ è‡ªé¸é¤å–®</button>
            </div>
            
            <div id="day-toggles" class="filter-grid" style="display:none;">
                <!-- Dynamically populated -->
            </div>
        </div>

        <div id="shopping-list-content">
            <p style="color: #999; text-align: center; padding: 20px;">æš«ç„¡è³‡æ–™ï¼Œè«‹å…ˆç”Ÿæˆé¤å–®ã€‚</p>
        </div>
    </div>
</div>

<!-- 3. è¨­å®šé é¢ -->
<div id="view-settings" class="view">
    <div class="card">
        <h2 style="margin-top:0;">âš™ï¸ ç³»çµ±è¨­å®š</h2>
        
        <div class="input-group">
            <label>Google Gemini API Key (å¿…å¡«)</label>
            <input type="password" id="apiKey" placeholder="è²¼ä¸Šä½ çš„ API Key" onchange="saveSettings()">
            <small style="display:block; color:#888; margin-top:6px; font-size:0.8rem;">
                Key åƒ…å„²å­˜æ–¼ä½ çš„ç€è¦½å™¨ï¼Œä¸æœƒä¸Šå‚³ã€‚
                <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--primary);">å…è²»ç²å– Key</a>
            </small>
        </div>

        <!-- Data Transfer Section -->
        <label>ğŸ’¾ è³‡æ–™å‚™ä»½èˆ‡è½‰ç§»</label>
        <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">åˆ‡æ›è£ç½®æ™‚ï¼Œè«‹å…ˆã€ŒåŒ¯å‡ºã€ä¸¦è¤‡è£½ä»£ç¢¼ï¼Œå†åˆ°æ–°è£ç½®ã€ŒåŒ¯å…¥ã€ã€‚</p>
        <div class="data-transfer-grid">
            <button class="btn-small" onclick="exportData()">
                â¬†ï¸ åŒ¯å‡ºè³‡æ–™
            </button>
            <button class="btn-small" onclick="openImportModal()">
                â¬‡ï¸ åŒ¯å…¥è³‡æ–™
            </button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ  é è¨­åå¥½ (Prompt)</h3>
        
        <div class="input-group">
            <label>é¤å–®è©³ç´°åº¦</label>
            <label class="checkbox-label">
                <input type="checkbox" id="detailedMeals" onchange="saveSettings()">
                <span>ğŸ“ ç”Ÿæˆè©³ç´°æ—©åˆé¤ (åŒ…æ‹¬åšæ³•/å‚™æ–™)</span>
            </label>
            <small style="color:#666; margin-left:30px;">å‹¾é¸å¾Œï¼ŒAI æœƒæä¾›æ—©åˆé¤çš„è©³ç´°åšæ³•åŠåŠ å…¥è²·é¤¸æ¸…å–®ã€‚</small>
        </div>

        <p style="font-size:0.85rem; color:#666; margin-bottom:15px;">AI æŒ‡ä»¤ï¼š</p>
        
        <div class="input-group">
            <textarea id="promptInput" onchange="saveSettings()"></textarea>
        </div>

        <button onclick="generatePlan()" class="btn-main">âœ¨ ç”Ÿæˆ 7 å¤©é¤å–®</button>
        <button onclick="clearData()" class="btn-main btn-ghost">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
    </div>
    
    <div class="card">
        <h3>â¤ï¸ AI è¨˜æ†¶åº«</h3>
        <p style="font-size:0.8rem; color:#666;">ç³»çµ±æœƒè¨˜ä½ä½ é»éè®šæˆ–ä¸å–œæ­¡çš„èœå¼ã€‚</p>
        <div style="font-size: 0.85rem;" id="pref-display"></div>
    </div>
</div>

<!-- Info Modal (Recipe/Nutrition) -->
<div id="info-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('info-modal')">&times;</span>
        <h2 id="modal-title" style="margin-top:0; font-size:1.4rem; color:var(--primary-dark);"></h2>
        <div id="modal-body" class="modal-body"></div>
    </div>
</div>

<!-- Import Modal -->
<div id="import-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('import-modal')">&times;</span>
        <h2 style="margin-top:0; font-size:1.4rem; color:var(--primary-dark);">åŒ¯å…¥è³‡æ–™</h2>
        <p style="font-size:0.9rem; color:#666;">è«‹å°‡èˆŠè£ç½®åŒ¯å‡ºçš„ä»£ç¢¼è²¼åœ¨ä¸‹æ–¹ï¼š</p>
        <textarea id="import-text" style="height:150px; font-family:monospace; font-size:0.8rem;" placeholder='{"apiKey": "...", "plan": ...}'></textarea>
        <button onclick="importData()" class="btn-main" style="margin-top:10px;">ç¢ºèªåŒ¯å…¥</button>
    </div>
</div>

<!-- Welcome Modal (Startup) -->
<div id="welcome-modal" class="modal">
    <div class="modal-content" style="text-align: center;">
        <span class="welcome-icon">ğŸ‘‹</span>
        <h2 style="margin-top:0; color:var(--primary);">æ­¡è¿ä½¿ç”¨æ™ºèƒ½å»šæˆ¿</h2>
        <p style="color:#666; line-height:1.6; margin-bottom:20px;">
            æˆ‘å€‘å·²ç‚ºä½ æº–å‚™äº†ä¸€ä»½é è¨­çš„ã€Œæ¸¯å¼å®¶å¸¸é¤å–®ã€ã€‚<br>
            ä½ å¯ä»¥ç›´æ¥é–‹å§‹ç€è¦½ï¼Œæˆ–è€…å‰å¾€è¨­å®šè¼¸å…¥ API Key ä¾†è®“ AI ç‚ºä½ åº¦èº«è¨‚é€ ã€‚
        </p>
        <div class="welcome-actions">
            <button onclick="closeModal('welcome-modal')" class="btn-main btn-outlined">é–‹å§‹ä½¿ç”¨</button>
            <button onclick="closeModal('welcome-modal'); switchTab('settings');" class="btn-main">å‰å¾€è¨­å®š</button>
        </div>
    </div>
</div>

<!-- Navigation -->
<nav>
    <button onclick="switchTab('plan')" id="nav-plan" class="active">
        <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
        é¤å–®
    </button>
    <button onclick="switchTab('shop')" id="nav-shop">
        <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
        è²·é¤¸
    </button>
    <button onclick="switchTab('settings')" id="nav-settings">
        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.04.24.24.41.48.41h3.84c.24 0 .43-.17.47-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
        è¨­å®š
    </button>
</nav>

<script>
    // --- APP LOGIC ---

    const DEFAULT_PROMPT = `è§’è‰²ï¼šä½ ä¿‚ä¸€ä½è­˜ç…®é¤¸åˆå¥½æœ‰æ¢ç†å˜…æ¸¯å¼å®¶å¸¸èœé¤å–®è¨­è¨ˆå¸«ã€‚
ä»»å‹™ï¼šè¨­è¨ˆä¸€å€‹ã€Œ7å¤©ã€3äººä»½ã€å˜…ä¸­å¼ï¼æ¸¯å¼æ™šé¤é¤å–®ã€‚
èƒŒæ™¯é™åˆ¶ï¼š
1. é¢¨æ ¼ï¼šæ¸¯å¼å®¶å¸¸ï¼Œé£Ÿæä»¥é¦™æ¸¯è¡—å¸‚æ˜“è²·ç‚ºä¸»ã€‚
2. å¥åº·ï¼š7å¤©ä¸­æœ‰ 4å¤©è¦åæ¸…æ·¡é¤Šç”Ÿï¼ˆè’¸/æ¹¯/å°‘æ²¹ï¼‰ï¼Œå…¶é¤˜ 3å¤© æ­£å¸¸å®¶å¸¸ã€‚
3. ç¦å¿Œï¼š7å¤©å…§æœ€å¤šåªå¯å‡ºç¾ 1æ¬¡è¦æˆ–èŸ¹ã€‚ä¸»è¦è›‹ç™½ä¸è¦é‡è¤‡è¶…é2æ¬¡ã€‚
4. å»šå…·ï¼šæ°´æ³¢çˆï¼ˆå¯è’¸å¯ç„—ï¼‰ã€æ˜ç«ç‚’é‘Šã€å¹³åº•é‘Šã€‚
5. å‚™é¤ï¼šå®‰æ’ 1-2 æ™šä½¿ç”¨ã€Œå‰©é¤¸ã€åšè®ŠåŒ–ï¼ˆå¦‚ç‚’é£¯ï¼‰ã€‚
è¼¸å‡ºæ ¼å¼ï¼šå¿…é ˆæ˜¯ç´” JSONï¼Œä¸è¦ç”¨ markdown code blockã€‚
çµæ§‹ç¯„ä¾‹ï¼š
{
  "days": [
    {
      "day": 1,
      "meals": {
        "breakfast": "ç°¡å–®æè¿° æˆ– {main, method, prep} ç‰©ä»¶ (å¦‚ç”¨æˆ¶è¦æ±‚è©³ç´°)",
        "lunch": "ç°¡å–®æè¿° æˆ– {main, method, prep} ç‰©ä»¶ (å¦‚ç”¨æˆ¶è¦æ±‚è©³ç´°)",
        "dinner": {
           "main": "ä¸»èœå",
           "side": "å‰¯èœå",
           "soup": "æ¹¯æ°´",
           "staple": "ä¸»é£Ÿ",
           "is_light": true,
           "method": "ç°¡è¿°åšæ³•èˆ‡å»šå…·",
           "prep": "éœ€é å…ˆæº–å‚™çš„æ­¥é©Ÿ"
        }
      },
      "daily_shopping": {
         "proteins": ["é …ç›®"],
         "veggies": ["é …ç›®"],
         "others": ["é …ç›®"]
      }
    }
  ]
}`;

    // Dummy Data for immediate start - Updated structure for daily filtering
    const DEFAULT_PLAN = {
        "days": [
            { 
                "day": 1, 
                "meals": { "breakfast": "è…¿è›‹æ²» + å’–å•¡", "lunch": "é›²åéºµ (å¤–è³£/è‡ªç…®)", "dinner": { "main": "æ¸…è’¸æµ·ä¸Šé®® (è’¸é­š)", "side": "è’œè“‰ç‚’èœå¿ƒ", "soup": "ç²Ÿç±³ç´…è˜¿è””è±¬éª¨æ¹¯", "staple": "ç™½é£¯", "is_light": true, "method": "é­šæ´—æ·¨æ“¦ä¹¾ï¼Œæ°´æ»¾è’¸8åˆ†é˜ï¼Œæ·‹ç†Ÿæ²¹è±‰æ²¹ã€‚", "prep": "æ—©ä¸Šè§£å‡è±¬éª¨" } },
                "daily_shopping": { "proteins": ["é­š (1æ¢)", "è±¬éª¨ (300g)"], "veggies": ["èœå¿ƒ", "ç²Ÿç±³", "ç´…è˜¿è””"], "others": ["è–‘", "è”¥"] }
            },
            { 
                "day": 2, 
                "meals": { "breakfast": "çš®è›‹ç˜¦è‚‰ç²¥", "lunch": "ç…é¤ƒ + èœ", "dinner": { "main": "å†¬è‡æ»‘é›", "side": "æ¸…ç‚’è¥¿è˜­èŠ±", "soup": "æ˜¨æ™šæ¹¯æ°´", "staple": "ç™½é£¯", "is_light": true, "method": "é›é†ƒ30åˆ†é˜ï¼Œéš”æ°´è’¸15åˆ†é˜ã€‚", "prep": "å†¬è‡æµ¸è»Ÿ" } },
                "daily_shopping": { "proteins": ["é› (åŠéš»)", "ç˜¦è‚‰ (100g)"], "veggies": ["è¥¿è˜­èŠ±"], "others": ["çš®è›‹", "å†¬è‡", "é¤ƒå­çš®"] }
            },
            { 
                "day": 3, 
                "meals": { "breakfast": "è…¸ç²‰ + ç‡’è³£", "lunch": "æšå·ç‚’é£¯ (ç”¨æ˜¨æ™šå†·é£¯)", "dinner": { "main": "æ´‹è”¥è±¬æ‰’", "side": "é­šé¦™èŒ„å­", "soup": "ç•ªèŒ„è±†è…æ¹¯", "staple": "ç™½é£¯", "is_light": false, "method": "è±¬æ‰’ç…é¦™å…©é¢ï¼Œå›é‘Šç‚’æ´‹è”¥æ±ã€‚", "prep": "è±¬æ‰’æ‹é¬†é†ƒå‘³" } },
                "daily_shopping": { "proteins": ["è±¬æ‰’ (3å¡Š)"], "veggies": ["æ´‹è”¥", "èŒ„å­", "ç•ªèŒ„"], "others": ["è±†è…", "ç‡’è³£(æ€¥å‡)", "è…¸ç²‰"] }
            },
            { 
                "day": 4, 
                "meals": { "breakfast": "éº¥çš® + æ°´ç…®è›‹", "lunch": "æ¹¯çƒå†¬", "dinner": { "main": "å‹ç“œè’¸è‚‰ç¢", "side": "ç‘¤æŸ±è’¸è›‹", "soup": "ç´«èœè›‹èŠ±æ¹¯", "staple": "ç³™ç±³é£¯", "is_light": true, "method": "è‚‰ç¢é‹ªå‹ç“œé¢è’¸10åˆ†é˜ã€‚", "prep": "ç‘¤æŸ±æµ¸è»Ÿ" } },
                "daily_shopping": { "proteins": ["å…æ²»è±¬è‚‰ (300g)", "é›è›‹ (4éš»)"], "veggies": ["å‹ç“œ"], "others": ["ç‘¤æŸ±", "ç´«èœ", "çƒå†¬"] }
            },
            { 
                "day": 5, 
                "meals": { "breakfast": "ç«è…¿é€šç²‰", "lunch": "è‚‰é†¬æ„ç²‰", "dinner": { "main": "è¥¿èŠ¹ç‚’é›æŸ³", "side": "è¦ä»ç‚’è›‹", "soup": "åˆæŒç“œç˜¦è‚‰æ¹¯", "staple": "ç™½é£¯", "is_light": false, "method": "é›æŸ³å¿«ç‚’ä¿æŒå«©æ»‘ã€‚", "prep": "è¦ä»å»è…¸" } },
                "daily_shopping": { "proteins": ["é›æŸ³ (200g)", "è¦ä» (200g)", "ç˜¦è‚‰ (200g)"], "veggies": ["è¥¿èŠ¹", "åˆæŒç“œ"], "others": ["é€šç²‰", "ç«è…¿", "æ„ç²‰"] }
            },
            { 
                "day": 6, 
                "meals": { "breakfast": "é¤è›‹éºµ", "lunch": "ç°¡å–®ä¸‰æ–‡æ²»", "dinner": { "main": "æ¢…èœè’¸é¯‡é­š", "side": "ä¸Šæ¹¯æµ¸è èœ", "soup": "é’ç´…è˜¿è””è±¬è…±æ¹¯", "staple": "ç™½é£¯", "is_light": true, "method": "æ¢…èœæ´—æ·¨é‹ªé­šé¢è’¸ã€‚", "prep": "è±¬è…±æ±†æ°´" } },
                "daily_shopping": { "proteins": ["é¯‡é­šè…©", "è±¬è…±"], "veggies": ["è èœ", "é’ç´…è˜¿è””"], "others": ["æ¢…èœ", "åˆé¤è‚‰", "å…¬ä»”éºµ"] }
            },
            { 
                "day": 7, 
                "meals": { "breakfast": "å»èŒ¶æ¨“é£²èŒ¶", "lunch": "é£²èŒ¶é»å¿ƒ", "dinner": { "main": "è±‰æ±è’¸æ’éª¨", "side": "è€å°‘å¹³å®‰ (è±†è…é¯ªé­šè‚‰)", "soup": "æ˜¨æ™šæ¹¯æ°´", "staple": "ç™½é£¯", "is_light": false, "method": "æ’éª¨è±†è±‰æ’ˆå‹»è’¸15åˆ†é˜ã€‚", "prep": "æ’éª¨é†ƒå…¥å‘³" } },
                "daily_shopping": { "proteins": ["æ’éª¨ (300g)", "é¯ªé­šè‚‰ (150g)"], "veggies": [], "others": ["è±†è…", "è±†è±‰"] }
            }
        ]
    };

    // State
    const state = {
        apiKey: '',
        prompt: DEFAULT_PROMPT,
        plan: null,
        prefs: { liked: [], disliked: [] },
        shopFilter: { mode: 'all', selectedDays: [] }, // 'all' or 'select'
        detailedMeals: false // Toggle for detailed breakfast/lunch
    };

    // --- INIT ---
    window.onload = () => {
        loadState();
        renderPrefs();
        
        // 1. å¦‚æœæ²’æœ‰å„²å­˜çš„é¤å–®ï¼Œè¼‰å…¥é è¨­é¤å–®
        if (!state.plan) {
            state.plan = DEFAULT_PLAN;
        }

        renderPlan();
        
        // 2. å¦‚æœæ²’æœ‰ API Keyï¼Œå½ˆå‡ºæ­¡è¿ Modal
        if (!state.apiKey) {
            document.getElementById('welcome-modal').classList.add('active');
        }
        
        document.getElementById('shopping-list-content').addEventListener('change', (e) => {
            if(e.target.type === 'checkbox') {
                e.target.parentElement.classList.toggle('checked', e.target.checked);
            }
        });
    };

    function loadState() {
        state.apiKey = localStorage.getItem('hkchef_key') || '';
        state.prompt = localStorage.getItem('hkchef_prompt') || DEFAULT_PROMPT;
        state.detailedMeals = localStorage.getItem('hkchef_detailed') === 'true'; // Load boolean
        const savedPlan = localStorage.getItem('hkchef_plan');
        if (savedPlan) state.plan = JSON.parse(savedPlan);
        const savedPrefs = localStorage.getItem('hkchef_prefs');
        if (savedPrefs) state.prefs = JSON.parse(savedPrefs);

        document.getElementById('apiKey').value = state.apiKey;
        document.getElementById('promptInput').value = state.prompt;
        document.getElementById('detailedMeals').checked = state.detailedMeals;
        updateStatus();
        
        // Initialize filters selectedDays if empty
        if(state.plan && state.plan.days) {
            state.shopFilter.selectedDays = state.plan.days.map((_, i) => i);
        }
    }

    function saveSettings() {
        state.apiKey = document.getElementById('apiKey').value.trim();
        state.prompt = document.getElementById('promptInput').value.trim();
        state.detailedMeals = document.getElementById('detailedMeals').checked;
        
        localStorage.setItem('hkchef_key', state.apiKey);
        localStorage.setItem('hkchef_prompt', state.prompt);
        localStorage.setItem('hkchef_detailed', state.detailedMeals);
        updateStatus();
    }
    
    function updateStatus() {
        const badge = document.getElementById('statusBadge');
        if (state.apiKey) {
            badge.textContent = 'API Ready';
            badge.classList.add('active');
        } else {
            badge.textContent = 'API æœªè¨­å®š';
            badge.classList.remove('active');
        }
    }

    function clearData() {
        if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼ˆåŒ…æ‹¬ API Keyã€é¤å–®ã€å–œå¥½ï¼‰ï¼Ÿ')) {
            localStorage.clear();
            location.reload();
        }
    }

    // --- DATA EXPORT/IMPORT ---
    
    function exportData() {
        const data = {
            apiKey: state.apiKey,
            prompt: state.prompt,
            plan: state.plan,
            prefs: state.prefs,
            detailedMeals: state.detailedMeals,
            timestamp: new Date().toISOString()
        };
        const jsonStr = JSON.stringify(data);
        
        // Copy to clipboard
        navigator.clipboard.writeText(jsonStr).then(() => {
            alert('âœ… è³‡æ–™å·²è¤‡è£½ï¼\nè«‹å°‡é€™äº›æ–‡å­—å‚³é€åˆ°æ–°è£ç½®ï¼Œç„¶å¾Œä½¿ç”¨ã€ŒåŒ¯å…¥è³‡æ–™ã€åŠŸèƒ½ã€‚');
        }).catch(err => {
            console.error(err);
            prompt('ç„¡æ³•è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹ä»£ç¢¼ï¼š', jsonStr);
        });
    }

    function openImportModal() {
        openModal('import-modal');
        document.getElementById('import-text').value = '';
    }

    function importData() {
        const txt = document.getElementById('import-text').value.trim();
        if (!txt) return;

        try {
            const data = JSON.parse(txt);
            
            // Validate minimal structure
            if (!data.prefs) throw new Error('Invalid Data');

            // Save to LocalStorage
            if (data.apiKey) localStorage.setItem('hkchef_key', data.apiKey);
            if (data.prompt) localStorage.setItem('hkchef_prompt', data.prompt);
            if (data.detailedMeals !== undefined) localStorage.setItem('hkchef_detailed', data.detailedMeals);
            if (data.plan) localStorage.setItem('hkchef_plan', JSON.stringify(data.plan));
            if (data.prefs) localStorage.setItem('hkchef_prefs', JSON.stringify(data.prefs));

            alert('ğŸ‰ åŒ¯å…¥æˆåŠŸï¼é é¢å°‡é‡æ–°è¼‰å…¥ã€‚');
            location.reload();

        } catch (e) {
            alert('âŒ åŒ¯å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤ã€‚è«‹ç¢ºä¿è¤‡è£½äº†å®Œæ•´çš„ JSON ä»£ç¢¼ã€‚');
        }
    }

    // --- AI GENERATION ---

    async function generatePlan() {
        if (!state.apiKey) {
            alert('è«‹å…ˆè¼¸å…¥ API Keyï¼');
            switchTab('settings');
            return;
        }

        switchTab('plan');
        document.getElementById('plan-container').style.display = 'none';
        document.getElementById('plan-list').innerHTML = '';
        document.getElementById('loading').style.display = 'flex';

        let finalPrompt = state.prompt;
        
        // Append Detailed Instruction if enabled
        if (state.detailedMeals) {
            finalPrompt += `\n\n[é‡è¦æŒ‡ä»¤ï¼šè©³ç´°æ—©åˆé¤] 
            è«‹å°‡ breakfast å’Œ lunch ä¹Ÿç”Ÿæˆç‚ºè©³ç´°ç‰©ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
            "breakfast": { "main": "èœå", "method": "åšæ³•ç°¡è¿°", "prep": "å‚™æ–™" },
            "lunch": { "main": "èœå", "method": "åšæ³•ç°¡è¿°", "prep": "å‚™æ–™" }
            åŒæ™‚è«‹ç¢ºä¿æ—©åˆé¤çš„æ‰€éœ€é£Ÿæä¹ŸåŠ å…¥åˆ° daily_shopping æ¸…å–®ä¸­ã€‚`;
        } else {
             finalPrompt += `\n\n[æŒ‡ä»¤] breakfast å’Œ lunch åªéœ€æä¾›å­—ä¸²æè¿°å³å¯ (String)ã€‚`;
        }

        if (state.prefs.liked.length > 0) {
            finalPrompt += `\n\n[ç”¨æˆ¶å–œå¥½] è«‹é©é‡å®‰æ’ç”¨æˆ¶å–œæ­¡çš„èœå¼ï¼š${state.prefs.liked.join(', ')}ã€‚`;
        }
        if (state.prefs.disliked.length > 0) {
            finalPrompt += `\n\n[ç”¨æˆ¶è¨å­] è«‹çµ•å°é¿é–‹ä»¥ä¸‹èœå¼ï¼š${state.prefs.disliked.join(', ')}ã€‚`;
        }
        finalPrompt += `\n\n[é‡è¦] è«‹åªå›å‚³ JSON æ ¼å¼å­—ä¸²ï¼Œä¸è¦åŒ…å« \`\`\`json æ¨™è¨˜ã€‚`;

        try {
            const result = await callGemini(finalPrompt);
            const json = cleanAndParseJSON(result);
            state.plan = json;
            localStorage.setItem('hkchef_plan', JSON.stringify(json));
            // Reset filters to select all
            state.shopFilter.selectedDays = json.days.map((_, i) => i);
            renderPlan();
        } catch (e) {
            alert('ç”Ÿæˆå¤±æ•—ï¼š' + e.message);
            // æ¢å¾©é¡¯ç¤ºèˆŠé¤å–® (å¦‚æœæœ‰çš„è©±)
            if(state.plan) renderPlan();
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    async function regenerateMeal(dayIndex, type) {
        if (!state.apiKey) {
            alert('è«‹å…ˆåœ¨è¨­å®šè¼¸å…¥ API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ï¼');
            switchTab('settings');
            return;
        }
        if(!confirm('ç¢ºå®šè¦ AI é‡æ–°å»ºè­°é€™ä¸€é¤å—ï¼Ÿ')) return;
        
        const btn = document.getElementById(`regen-${dayIndex}-${type}`);
        btn.textContent = '...';
        btn.disabled = true;

        const currentDinner = state.plan.days[dayIndex].meals.dinner;
        let context = `è«‹ç‚ºç¬¬ ${dayIndex+1} å¤©çš„ ${type === 'dinner' ? 'æ™šé¤' : getMealLabel(type)} é‡æ–°å»ºè­°ä¸€å€‹èœå¼ã€‚`;
        
        if (type === 'dinner') {
             context += `
             åŸä¾†çš„æ™šé¤æ˜¯ï¼š${currentDinner.main}ã€‚ç”¨æˆ¶æƒ³æ›ä¸€å€‹ã€‚
             è¦æ±‚ï¼šæ¸¯å¼å®¶å¸¸ï¼ŒåŒ…æ‹¬ä¸»èœã€å‰¯èœã€æ¹¯ã€ä¸»é£Ÿã€‚
             é¿é–‹ï¼š${state.prefs.disliked.join(', ')}ã€‚
             å›å‚³æ ¼å¼ï¼šåªå›å‚³è©²é¤çš„ JSON å°è±¡ (ä¸è¦ Markdown):
             { "main": "...", "side": "...", "soup": "...", "staple": "...", "is_light": true/false, "method": "...", "prep": "..." }
             `;
        } else {
             // For Breakfast/Lunch regeneration
             if (state.detailedMeals) {
                 context += `
                 è¦æ±‚ï¼šè©³ç´°åšæ³•ã€‚
                 å›å‚³æ ¼å¼ï¼šåªå›å‚³è©²é¤çš„ JSON å°è±¡:
                 { "main": "...", "method": "...", "prep": "..." }
                 `;
             } else {
                 context += `è¦æ±‚ç°¡å–®å¿«æ·ã€‚åªå›å‚³å­—ä¸²æè¿°å³å¯ã€‚`;
             }
        }

        try {
            const result = await callGemini(context);
            
            if (type === 'dinner') {
                const newMeal = cleanAndParseJSON(result);
                state.plan.days[dayIndex].meals.dinner = newMeal;
            } else {
                // If detailed, result is JSON, else string
                if (state.detailedMeals) {
                     state.plan.days[dayIndex].meals[type] = cleanAndParseJSON(result);
                } else {
                     state.plan.days[dayIndex].meals[type] = result.replace(/"/g, ''); 
                }
            }
            
            localStorage.setItem('hkchef_plan', JSON.stringify(state.plan));
            renderPlan();
        } catch (e) {
            alert('é‡è©¦å¤±æ•—');
            btn.textContent = 'é‡è©¦';
            btn.disabled = false;
        }
    }

    function getMealLabel(type) {
        if(type === 'breakfast') return 'æ—©é¤';
        if(type === 'lunch') return 'åˆé¤';
        return type;
    }

    // --- NEW AI FEATURES ---

    async function getSmartRecipe(dishName) {
        if (!state.apiKey) {
            alert('è«‹å…ˆåœ¨è¨­å®šè¼¸å…¥ API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ï¼');
            switchTab('settings');
            return;
        }
        openModal('info-modal', 'ğŸ‘¨â€ğŸ³ æ™ºèƒ½å¤§å»šç·¨å¯«ä¸­...', '<div class="spinner" style="margin:40px auto"></div><p style="text-align:center">AI æ­£åœ¨è¨ˆç®—ä¸‰äººä»½é‡åŠæ­¥é©Ÿ...</p>');
        
        const prompt = `ä½ æ˜¯ä¸€ä½æœ‰ 20 å¹´ç¶“é©—çš„é¦™æ¸¯ç²µèœå¤§å»šã€‚
        ä»»å‹™ï¼šè«‹æ•™æˆ‘ç…®ã€Œ${dishName}ã€ã€‚
        
        è«‹ç”¨ HTML æ ¼å¼ (ä½¿ç”¨ h3, ul, ol, li, strong æ¨™ç±¤) è¼¸å‡ºè©³ç´°é£Ÿè­œï¼ŒåŒ…æ‹¬ï¼š
        1. <h3>ææ–™ï¼ˆ3äººä»½ï¼‰</h3>ï¼šç²¾ç¢ºåˆ°å…‹/æ¹¯åŒ™ï¼ŒåŒ…æ‹¬å»è¡—å¸‚è²·é¤¸çš„è²¼å£«ã€‚
        2. <h3>é†ƒæ–™/èª¿å‘³</h3>
        3. <h3>çƒ¹é£ªæ­¥é©Ÿ</h3>ï¼šä¸€æ­¥æ­¥æ•™ï¼ŒåŒ…æ‹¬ç«å€™æ§åˆ¶ã€‚
        4. <h3>å¤§å»šç§˜è¨£</h3>ï¼šå¦‚ä½•ä»¤é€™é“èœæ›´å¥½åƒçš„é—œéµè²¼å£«ã€‚
        
        è«‹ä¸è¦ç”¨ Markdown æ ¼å¼ï¼Œç›´æ¥çµ¦ HTML ç‰‡æ®µã€‚ç¹é«”ä¸­æ–‡ã€‚`;

        try {
            const html = await callGemini(prompt);
            // Simple cleanup if gemini adds markdown
            const cleanHtml = html.replace(/```html/g, '').replace(/```/g, '');
            openModal('info-modal', 'ğŸ“– ' + dishName, cleanHtml);
        } catch (e) {
            openModal('info-modal', 'éŒ¯èª¤', 'ç„¡æ³•ç”Ÿæˆé£Ÿè­œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }
    }

    async function getNutritionReport() {
        if (!state.apiKey) {
            alert('è«‹å…ˆåœ¨è¨­å®šè¼¸å…¥ API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ï¼');
            switchTab('settings');
            return;
        }
        if(!state.plan) return;
        openModal('info-modal', 'ğŸ“Š ç‡Ÿé¤Šå¸«åˆ†æä¸­...', '<div class="spinner" style="margin:40px auto"></div><p style="text-align:center">æ­£åœ¨åˆ†æ 7 å¤©é¤å–®çš„ç‡Ÿé¤Šå‡è¡¡åº¦...</p>');

        const dinners = state.plan.days.map(d => `Day ${d.day}: ${d.meals.dinner.main} + ${d.meals.dinner.side} (æ¹¯: ${d.meals.dinner.soup})`).join('\n');
        
        const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è¨»å†Šç‡Ÿé¤Šå¸«ã€‚è«‹åˆ†æä»¥ä¸‹é€™ä»½ 7 å¤©æ¸¯å¼æ™šé¤é¤å–®ï¼š
        ${dinners}
        
        è«‹ç”¨ HTML æ ¼å¼ (ä½¿ç”¨ h3, p, ul, li) æä¾›ä¸€ä»½ç°¡çŸ­å ±å‘Šï¼š
        1. <h3>æ•´é«”è©•åˆ†</h3> (1-10åˆ†) åŠçŸ­è©•ã€‚
        2. <h3>å„ªé»</h3>ï¼šä¾‹å¦‚è›‹ç™½è³ªè¶³å¤ ï¼Ÿè”¬èœå¤šï¼Ÿ
        3. <h3>æ”¹å–„å»ºè­°</h3>ï¼šä¾‹å¦‚å“ªå¹¾å¤©éˆ‰å«é‡å¯èƒ½å¤ªé«˜ï¼Ÿçº–ç¶­æ˜¯å¦è¶³å¤ ï¼Ÿæœ‰ä»€éº¼ç°¡å–®å»ºè­°ï¼Ÿ
        
        è«‹èªæ°£è¦ªåˆ‡å°ˆæ¥­ï¼Œç¹é«”ä¸­æ–‡ã€‚ä¸è¦ Markdownã€‚`;

        try {
            const html = await callGemini(prompt);
            const cleanHtml = html.replace(/```html/g, '').replace(/```/g, '');
            openModal('info-modal', 'ğŸ“Š æœ¬é€±ç‡Ÿé¤Šåˆ†æå ±å‘Š', cleanHtml);
        } catch (e) {
            openModal('info-modal', 'éŒ¯èª¤', 'åˆ†æå¤±æ•—ã€‚');
        }
    }

    async function callGemini(promptText) {
        // Updated to the latest supported model gemini-2.5-flash-preview-09-2025
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`;
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || 'API Error');
        return data.candidates[0].content.parts[0].text;
    }

    function cleanAndParseJSON(text) {
        let clean = text.replace(/```json/g, '').replace(/```/g, '');
        const start = clean.indexOf('{');
        const end = clean.lastIndexOf('}');
        if (start !== -1 && end !== -1) {
            clean = clean.substring(start, end + 1);
        }
        return JSON.parse(clean);
    }

    // --- UI RENDERING ---

    function renderPlan() {
        document.getElementById('plan-container').style.display = 'block';
        const container = document.getElementById('plan-list');
        container.innerHTML = '';
        if (!state.plan || !state.plan.days) return;

        state.plan.days.forEach((day, idx) => {
            const d = day.meals.dinner;
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="day-header">
                    <span class="day-tag">Day ${day.day}</span>
                    <span style="font-size:0.8rem; color:#888;">${d.is_light ? 'ğŸŒ± æ¸…æ·¡æ—¥' : 'ğŸ¥˜ å®¶å¸¸æ—¥'}</span>
                </div>
                
                <div class="meal-row">
                    <div class="meal-time">æ—©/åˆ</div>
                    <div class="meal-content">
                        ${renderSimpleOrDetailedMeal(idx, 'breakfast', day.meals.breakfast)}
                        <hr style="border:0; border-top:1px dashed #eee; margin:8px 0;">
                        ${renderSimpleOrDetailedMeal(idx, 'lunch', day.meals.lunch)}
                    </div>
                </div>

                <div class="meal-row">
                    <div class="meal-time">æ™šé¤</div>
                    <div class="meal-content dinner">
                        <div class="dish-name">${d.main} + ${d.side}</div>
                        <div class="dish-desc">æ¹¯ï¼š${d.soup}ï½œä¸»é£Ÿï¼š${d.staple}</div>
                        
                        <div class="tags">
                            ${d.prep ? `<span class="tag prep">âš ï¸ å‚™ï¼š${d.prep}</span>` : ''}
                            <span class="tag">ğŸ“ å»šï¼š${d.method}</span>
                        </div>

                        <div class="action-bar">
                            <button class="sparkle-btn" onclick="getSmartRecipe('${d.main}')">
                                ğŸ“– é£Ÿè­œ
                            </button>
                            <button class="regen-btn" id="regen-${idx}-dinner" onclick="regenerateMeal(${idx}, 'dinner')">
                                â†º æ›ä¸€é¤
                            </button>
                            <div class="feedback-btns">
                                <button class="feedback-btn ${isLiked(d.main) ? 'active like' : ''}" onclick="toggleLike('${d.main}', 'like')">ğŸ‘</button>
                                <button class="feedback-btn ${isDisliked(d.main) ? 'active dislike' : ''}" onclick="toggleLike('${d.main}', 'dislike')">ğŸ‘</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });

        // Initialize shop filters if they don't match days
        if (state.plan.days) {
             renderShopFilters();
        }
        renderShoppingList();
    }
    
    // Helper to render B/L based on type (string vs object)
    function renderSimpleOrDetailedMeal(dayIdx, type, mealData) {
        const label = type === 'breakfast' ? 'æ—©' : 'åˆ';
        let content = '';
        
        if (typeof mealData === 'string') {
            // Simple String Mode
            content = `<strong>${label}ï¼š</strong>${mealData}`;
        } else if (mealData && typeof mealData === 'object') {
            // Detailed Object Mode
            content = `
                <div style="margin-bottom:2px;"><strong>${label}ï¼š</strong>${mealData.main}</div>
                <div style="font-size:0.8rem; color:#666; margin-left:25px;">
                    ${mealData.prep ? `<span style="background:#e3f2fd; padding:1px 4px; border-radius:3px;">å‚™: ${mealData.prep}</span> ` : ''}
                    <span>æ³•: ${mealData.method}</span>
                     <button class="sparkle-btn secondary" style="display:inline-flex; padding:1px 6px; font-size:0.7rem; margin-left:5px;" onclick="getSmartRecipe('${mealData.main}')">ğŸ“–</button>
                </div>
            `;
        }
        
        return `
            <div style="font-size:0.9rem;">
                ${content} 
                <button class="regen-btn" style="float:right; margin-top:-20px;" id="regen-${dayIdx}-${type}" onclick="regenerateMeal(${dayIdx}, '${type}')">â†º</button>
            </div>
        `;
    }
    
    // --- SHOPPING FILTER LOGIC ---
    
    function setFilterMode(mode) {
        state.shopFilter.mode = mode;
        document.getElementById('btn-filter-all').classList.toggle('active', mode === 'all');
        document.getElementById('btn-filter-select').classList.toggle('active', mode === 'select');
        
        document.getElementById('day-toggles').style.display = mode === 'select' ? 'grid' : 'none';
        renderShoppingList();
    }
    
    function renderShopFilters() {
        const container = document.getElementById('day-toggles');
        container.innerHTML = '';
        if(!state.plan || !state.plan.days) return;
        
        state.plan.days.forEach((day, idx) => {
            const btn = document.createElement('div');
            btn.className = `day-toggle ${state.shopFilter.selectedDays.includes(idx) ? 'active' : ''}`;
            btn.onclick = () => toggleDayFilter(idx, btn);
            btn.innerHTML = `<span class="menu-name">Day ${day.day}</span><span style="font-size:0.75rem; color:#666;">${day.meals.dinner.main}</span>`;
            container.appendChild(btn);
        });
    }
    
    function toggleDayFilter(idx, btnEl) {
        if (state.shopFilter.selectedDays.includes(idx)) {
            state.shopFilter.selectedDays = state.shopFilter.selectedDays.filter(i => i !== idx);
            btnEl.classList.remove('active');
        } else {
            state.shopFilter.selectedDays.push(idx);
            btnEl.classList.add('active');
        }
        renderShoppingList();
    }

    function renderShoppingList() {
        const container = document.getElementById('shopping-list-content');
        const filterContainer = document.getElementById('shop-filters');
        
        if (!state.plan) {
             container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æš«ç„¡è³‡æ–™ï¼Œè«‹å…ˆç”Ÿæˆé¤å–®ã€‚</p>';
             return;
        }
        
        // COMPATIBILITY CHECK
        // If data is old format (global shopping list), hide filters and show basic list
        if (state.plan.shopping_list && !state.plan.days[0].daily_shopping) {
            filterContainer.style.display = 'none';
            renderGlobalShoppingList(state.plan.shopping_list);
            return;
        }

        // New Format: Per-Day shopping lists
        filterContainer.style.display = 'block';
        
        // Aggregate items
        const aggregated = { proteins: new Set(), veggies: new Set(), others: new Set() };
        
        // Determine indices to use
        const indices = state.shopFilter.mode === 'all' 
            ? state.plan.days.map((_, i) => i) 
            : state.shopFilter.selectedDays;
            
        indices.forEach(idx => {
            const daily = state.plan.days[idx].daily_shopping;
            if(daily) {
                if(daily.proteins) daily.proteins.forEach(i => aggregated.proteins.add(i));
                if(daily.veggies) daily.veggies.forEach(i => aggregated.veggies.add(i));
                if(daily.others) daily.others.forEach(i => aggregated.others.add(i));
            }
        });
        
        let html = '';
        const map = { 'proteins': 'ğŸ¥© é­šè‚‰é¡', 'veggies': 'ğŸ¥¬ è”¬èœé¡', 'others': 'ğŸ§‚ ä¹¾è²¨/å…¶ä»–' };
        let hasItems = false;
        
        for (let key in map) {
            if (aggregated[key].size > 0) {
                hasItems = true;
                html += `<div class="shop-cat"><div class="shop-cat-title">${map[key]}</div>`;
                aggregated[key].forEach(item => {
                    html += `<label class="shop-item"><input type="checkbox"><span>${item}</span></label>`;
                });
                html += `</div>`;
            }
        }
        
        if(!hasItems) {
            html = '<p style="text-align:center; color:#999; padding:20px;">æ²’æœ‰é¸æ“‡ä»»ä½•é¤å–®ï¼Œæˆ–é¤å–®æ²’æœ‰é£Ÿæè³‡æ–™ã€‚</p>';
        }
        
        container.innerHTML = html;
        
        // Restore check state? (Advanced feature, skipping for now as filtering resets view context usually)
    }
    
    function renderGlobalShoppingList(list) {
        const container = document.getElementById('shopping-list-content');
        let html = '<div style="background:#fff3e0; color:#e65100; padding:10px; font-size:0.8rem; border-radius:8px; margin-bottom:15px;">âš ï¸ æ­¤ç‚ºèˆŠç‰ˆé¤å–®è³‡æ–™ï¼Œä¸æ”¯æ´ã€Œè‡ªé¸é¤å–®ã€ç¯©é¸ã€‚è«‹é‡æ–°ç”Ÿæˆä»¥å•Ÿç”¨æ–°åŠŸèƒ½ã€‚</div>';
        const map = { 'proteins': 'ğŸ¥© é­šè‚‰é¡', 'veggies': 'ğŸ¥¬ è”¬èœé¡', 'others': 'ğŸ§‚ ä¹¾è²¨/å…¶ä»–' };
        
        for (let key in map) {
            if (list[key] && list[key].length > 0) {
                html += `<div class="shop-cat"><div class="shop-cat-title">${map[key]}</div>`;
                list[key].forEach(item => {
                    html += `<label class="shop-item"><input type="checkbox"><span>${item}</span></label>`;
                });
                html += `</div>`;
            }
        }
        container.innerHTML = html;
    }

    // --- MODAL ---
    function openModal(modalId, title, htmlContent) {
        if(title) document.getElementById('modal-title').textContent = title;
        if(htmlContent) document.getElementById('modal-body').innerHTML = htmlContent;
        document.getElementById(modalId).classList.add('active');
        document.body.style.overflow = 'hidden'; 
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
        document.body.style.overflow = '';
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.classList.remove('active');
            document.body.style.overflow = '';
        }
    }

    // --- PREFERENCES ---

    function isLiked(dish) { return state.prefs.liked.includes(dish); }
    function isDisliked(dish) { return state.prefs.disliked.includes(dish); }

    function toggleLike(dish, type) {
        if (type === 'like') {
            if (isLiked(dish)) {
                state.prefs.liked = state.prefs.liked.filter(i => i !== dish); 
            } else {
                state.prefs.liked.push(dish);
                state.prefs.disliked = state.prefs.disliked.filter(i => i !== dish); 
            }
        } else {
            if (isDisliked(dish)) {
                state.prefs.disliked = state.prefs.disliked.filter(i => i !== dish); 
            } else {
                state.prefs.disliked.push(dish);
                state.prefs.liked = state.prefs.liked.filter(i => i !== dish); 
            }
        }
        localStorage.setItem('hkchef_prefs', JSON.stringify(state.prefs));
        renderPlan(); 
        renderPrefs();
    }

    function renderPrefs() {
        const el = document.getElementById('pref-display');
        let txt = '';
        if (state.prefs.liked.length) txt += `<span style="color:var(--primary)">ğŸ‘ ${state.prefs.liked.join(', ')}</span><br>`;
        if (state.prefs.disliked.length) txt += `<span style="color:var(--danger)">ğŸ‘ ${state.prefs.disliked.join(', ')}</span>`;
        el.innerHTML = txt || 'æš«ç„¡è¨˜éŒ„';
    }

    // --- TABS ---
    function switchTab(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(`view-${id}`).classList.add('active');
        document.getElementById(`nav-${id}`).classList.add('active');
        window.scrollTo(0,0);
    }
</script>

</body>
</html>
